<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellsystem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1 0 auto;
        }

        footer {
            flex-shrink: 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="notification-container"></div>

    <div class="main-content">
        <!-- Navigation -->
        <nav class="bg-slate-800 text-white shadow-lg">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between h-16">
                    <h1 class="text-2xl font-bold">Bestellsystem</h1>
                    <div class="flex space-x-4">
                        <button onclick="showTab('dashboard')"
                            class="tab-btn px-4 py-2 rounded hover:bg-slate-700">Dashboard</button>
                        <button onclick="showTab('kunden')"
                            class="tab-btn px-4 py-2 rounded hover:bg-slate-700">Kunden</button>
                        <button onclick="showTab('produkte')"
                            class="tab-btn px-4 py-2 rounded hover:bg-slate-700">Produkte</button>
                        <button onclick="showTab('bestellungen')"
                            class="tab-btn px-4 py-2 rounded hover:bg-slate-700">Bestellungen</button>
                        <button onclick="showTab('rechnungen')"
                            class="tab-btn px-4 py-2 rounded hover:bg-slate-700">Rechnungen</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-8">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-gray-500 text-sm">Kunden</div>
                        <div id="stats-kunden" class="text-3xl font-bold text-blue-600">-</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-gray-500 text-sm">Produkte</div>
                        <div id="stats-produkte" class="text-3xl font-bold text-green-600">-</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-gray-500 text-sm">Bestellungen</div>
                        <div id="stats-bestellungen" class="text-3xl font-bold text-purple-600">-</div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-bold mb-4">Letzte Bestellungen</h3>
                    <div id="recent-orders"></div>
                </div>
            </div>

            <!-- Kunden Tab -->
            <div id="kunden" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Kunden</h2>
                    <button onclick="showKundeForm()"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Neuer Kunde</button>
                </div>

                <div id="kunde-form" class="hidden bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-bold mb-4">Kunde bearbeiten</h3>
                    <form onsubmit="saveKunde(event)">
                        <input type="hidden" id="kunde-id">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Vorname *</label>
                                <input type="text" id="kunde-vorname" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Name *</label>
                                <input type="text" id="kunde-name" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Email *</label>
                                <input type="email" id="kunde-email" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Geburtstag *</label>
                                <input type="text" id="kunde-geburtstag" required pattern="\d{4}-\d{2}-\d{2}"
                                    placeholder="yyyy-mm-dd"
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Strasse *</label>
                                <input type="text" id="kunde-strasse" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Hausnummer *</label>
                                <input type="text" id="kunde-hausnummer" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Postleitzahl *</label>
                                <input type="text" id="kunde-postleitzahl" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Ort *</label>
                                <input type="text" id="kunde-ort" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Land *</label>
                                <input type="text" id="kunde-land" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Telefonnummer </label>
                                <input type="text" id="kunde-telefonnummer"
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Mobilnummer</label>
                                <input type="text" id="kunde-mobilnummer"
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Geschlecht *</label>
                                <select id="kunde-geschlecht" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500">
                                    <option value="">Bitte wählen...</option>
                                    <option value="MAENNLICH">Männlich</option>
                                    <option value="WEIBLICH">Weiblich</option>
                                    <option value="DIVERS">Divers</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit"
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Speichern</button>
                            <button type="button" onclick="hideKundeForm()"
                                class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Abbrechen</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vorname</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Strasse</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hausnummer
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Postleitzahl
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ort</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Geburtsdatum
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aktionen
                                </th>
                            </tr>
                        </thead>
                        <tbody id="kunden-list" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Produkte Tab -->
            <div id="produkte" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Produkte</h2>
                    <button onclick="showProduktForm()"
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">+ Neues Produkt</button>
                </div>

                <div id="produkt-form" class="hidden bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-bold mb-4">Produkt bearbeiten</h3>
                    <form onsubmit="saveProdukt(event)">
                        <input type="hidden" id="produkt-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Name *</label>
                                <input type="text" id="produkt-name" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Preis *</label>
                                <input type="number" step="0.01" id="produkt-preis" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Lagerbestand *</label>
                                <input type="number" id="produkt-lagerbestand" required
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Beschreibung</label>
                                <input type="text" id="produkt-beschreibung"
                                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit"
                                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Speichern</button>
                            <button type="button" onclick="hideProduktForm()"
                                class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Abbrechen</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Beschreibung
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Preis</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lagerbestand
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aktionen
                                </th>
                            </tr>
                        </thead>
                        <tbody id="produkte-list" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Bestellungen Tab -->
            <div id="bestellungen" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Bestellungen</h2>
                    <button onclick="showBestellungForm()"
                        class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">+ Neue
                        Bestellung</button>
                </div>

                <div id="bestellung-form" class="hidden bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-xl font-bold mb-4">Neue Bestellung</h3>
                    <form onsubmit="saveBestellung(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Kunde *</label>
                            <select id="bestellung-kunde" required
                                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-purple-500"></select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Produkte</label>
                            <div id="bestellung-positionen"></div>
                            <button type="button" onclick="addPosition()"
                                class="mt-2 text-sm text-purple-600 hover:text-purple-700">+ Position
                                hinzufügen</button>
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit"
                                class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">Bestellung
                                erstellen</button>
                            <button type="button" onclick="hideBestellungForm()"
                                class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Abbrechen</button>
                        </div>
                    </form>
                </div>

                <div class="space-y-4" id="bestellungen-list"></div>
            </div>

            <!-- Rechnungen Tab -->
            <div id="rechnungen" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Rechnungen</h2>
                    <div class="flex items-center space-x-2">
                        <div class="grid grid-cols-3 gap-2">
                            <input id="create-rechnung-bestellung-id" type="number" placeholder="Bestellung ID"
                                class="px-3 py-2 border rounded" />
                            <button onclick="createRechnung()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 whitespace-nowrap">Rechnung
                                erstellen</button>
                            <button onclick="rechnungslauf()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 whitespace-nowrap">Rechnungslauf</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nummer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bestellung
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kunde</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Erstellt
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Betrag</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aktionen
                                </th>
                            </tr>
                        </thead>
                        <tbody id="rechnungen-list" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-800 text-gray-300 mt-12">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-sm">&copy; 2025 Bestellsystem. Alle Rechte vorbehalten.</p>
                </div>
                <div class="flex space-x-6">
                    <a href="#" class="text-sm hover:text-white transition-colors">Impressum</a>
                    <a href="#" class="text-sm hover:text-white transition-colors">Kontakt</a>
                    <a href="#" class="text-sm hover:text-white transition-colors">Datenschutz</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const API_URL = '/order-system/api';
        let kunden = [];
        let produkte = [];
        let bestellungen = [];

        // Tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'kunden') loadKunden();
            if (tabName === 'produkte') loadProdukte();
            if (tabName === 'bestellungen') loadBestellungen();
            if (tabName === 'rechnungen') loadRechnungen();
        }

        // Notifications
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            notification.className = `notification ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Robust date formatter: accepts SQL timestamps like "YYYY-MM-DD HH:MM:SS(.ssssss)" and ISO strings
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const opts = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            // Handle array format from server: [year,month,day,hour,minute,second,frac]
            if (Array.isArray(dateStr)) {
                const [y, mo, da, hh, mm, ss, frac] = dateStr;
                const ms = frac ? Math.floor(Number(frac) / 1e6) : 0; // convert nanoseconds to ms
                try {
                    const d = new Date(y, mo - 1, da, hh || 0, mm || 0, ss || 0, ms);
                    if (!isNaN(d.getTime())) return d.toLocaleString('de-DE', opts).replace(',', '');
                } catch (e) {
                    // fall through to string parsing
                }
            }

            // Try native parse first (string/ISO)
            let d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d.toLocaleString('de-DE', opts).replace(',', '');

            // Replace space between date and time with 'T' to make it ISO-like
            let iso = String(dateStr).replace(' ', 'T');
            d = new Date(iso);
            if (!isNaN(d.getTime())) return d.toLocaleString('de-DE', opts).replace(',', '');

            // Trim fractional seconds to milliseconds (max 3 digits)
            iso = iso.replace(/\.(\d{3})\d+/, '.$1');
            d = new Date(iso);
            if (!isNaN(d.getTime())) return d.toLocaleString('de-DE', opts).replace(',', '');

            // As a last resort, try replacing space and adding Z (UTC)
            iso = String(dateStr).replace(' ', 'T') + 'Z';
            d = new Date(iso);
            if (!isNaN(d.getTime())) return d.toLocaleString('de-DE', opts).replace(',', '');

            return 'Invalid date';
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const [kundenRes, produkteRes, bestellungenRes] = await Promise.all([
                    fetch(`${API_URL}/kunden`),
                    fetch(`${API_URL}/produkte`),
                    fetch(`${API_URL}/bestellungen`)
                ]);

                kunden = await kundenRes.json();
                produkte = await produkteRes.json();
                bestellungen = await bestellungenRes.json();

                document.getElementById('stats-kunden').textContent = kunden.length;
                document.getElementById('stats-produkte').textContent = produkte.length;
                document.getElementById('stats-bestellungen').textContent = bestellungen.length;

                const recentOrders = bestellungen.slice(-5).reverse();
                document.getElementById('recent-orders').innerHTML = recentOrders.length ?
                    recentOrders.map(b => `
                        <div class="flex justify-between py-2 border-b">
                            <span>Bestellung #${b.id}</span>
                            <span class="font-bold">${b.gesamtpreis.toFixed(2)} €</span>
                            <span class="text-sm text-gray-500">${b.status}</span>
                        </div>
                    `).join('') : '<p class="text-gray-500">Keine Bestellungen vorhanden</p>';
            } catch (error) {
                showNotification('Fehler beim Laden des Dashboards', 'error');
            }
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';

            const d = new Date(dateStr);

            // Prüfen, ob das Datum gültig ist
            if (isNaN(d.getTime())) {
                return '-';
            }

            // Komponenten extrahieren und formatieren
            const year = d.getFullYear();
            // Monat (0-11, daher +1), mit führender Null (z.B. '05')
            const month = String(d.getMonth() + 1).padStart(2, '0');
            // Tag, mit führender Null (z.B. '04')
            const day = String(d.getDate()).padStart(2, '0');

            // Zusammenführen im Format yyyy-mm-dd
            return `${year}-${month}-${day}`;
        }

        // Kunden
        async function loadKunden() {
            try {
                const res = await fetch(`${API_URL}/kunden`);
                kunden = await res.json();
                document.getElementById('kunden-list').innerHTML = kunden.map(k => `
                    <tr>
                        <td class="px-6 py-4">${k.id}</td>
                        <td class="px-6 py-4 font-medium">${k.vorname}</td>
                        <td class="px-6 py-4 font-medium">${k.name}</td>
                        <td class="px-6 py-4">${k.strasse || '-'}</td>
                        <td class="px-6 py-4">${k.hausnummer || '-'}</td>
                        <td class="px-6 py-4">${k.postleitzahl || '-'}</td>
                        <td class="px-6 py-4">${k.ort || '-'}</td>
                        <td class="px-6 py-4">${formatDateShort(k.geburtstag) || '-'}</td>
                        <td class="px-6 py-4">${k.email}</td>
                        <td class="px-6 py-4">
                            <button onclick="editKunde(${k.id})" class="text-blue-600 hover:text-blue-800 mr-3">Bearbeiten</button>
                            <button onclick="deleteKunde(${k.id})" class="text-red-600 hover:text-red-800">Löschen</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showNotification('Fehler beim Laden der Kunden', 'error');
            }
        }

        function showKundeForm() {
            document.getElementById('kunde-form').classList.remove('hidden');
            document.getElementById('kunde-id').value = '';
            document.getElementById('kunde-vorname').value = '';
            document.getElementById('kunde-name').value = '';
            document.getElementById('kunde-email').value = '';
            document.getElementById('kunde-geburtstag').value = '';
            document.getElementById('kunde-strasse').value = '';
            document.getElementById('kunde-hausnummer').value = '';
            document.getElementById('kunde-postleitzahl').value = '';
            document.getElementById('kunde-ort').value = '';
            document.getElementById('kunde-land').value = '';
            document.getElementById('kunde-telefonnummer').value = '';
            document.getElementById('kunde-mobilnummer').value = '';
            document.getElementById('kunde-geschlecht').value = '';
        }

        function hideKundeForm() {
            document.getElementById('kunde-form').classList.add('hidden');
        }

        async function editKunde(id) {
            const kunde = kunden.find(k => k.id === id);
            if (!kunde) return;

            document.getElementById('kunde-form').classList.remove('hidden');
            document.getElementById('kunde-id').value = kunde.id;
            document.getElementById('kunde-name').value = kunde.name;
            document.getElementById('kunde-vorname').value = kunde.vorname;
            document.getElementById('kunde-email').value = kunde.email;
            document.getElementById('kunde-geburtstag').value = formatDateShort(kunde.geburtstag) || '';
            document.getElementById('kunde-strasse').value = kunde.strasse || '';
            document.getElementById('kunde-hausnummer').value = kunde.hausnummer || '';
            document.getElementById('kunde-postleitzahl').value = kunde.postleitzahl || '';
            document.getElementById('kunde-ort').value = kunde.ort || '';
            document.getElementById('kunde-land').value = kunde.land || '';
            document.getElementById('kunde-telefonnummer').value = kunde.telefonnummer || '';
            document.getElementById('kunde-mobilnummer').value = kunde.mobilnummer || '';
            document.getElementById('kunde-geschlecht').value = kunde.geschlecht || '';
        }

        async function saveKunde(event) {
            event.preventDefault();
            const id = document.getElementById('kunde-id').value;
            const kunde = {
                name: document.getElementById('kunde-name').value,
                vorname: document.getElementById('kunde-vorname').value,
                email: document.getElementById('kunde-email').value,
                geburtstag: document.getElementById('kunde-geburtstag').value,
                strasse: document.getElementById('kunde-strasse').value,
                hausnummer: document.getElementById('kunde-hausnummer').value,
                postleitzahl: document.getElementById('kunde-postleitzahl').value,
                ort: document.getElementById('kunde-ort').value,
                land: document.getElementById('kunde-land').value,
                telefonnummer: document.getElementById('kunde-telefonnummer').value,
                mobilnummer: document.getElementById('kunde-mobilnummer').value,
                geschlecht: document.getElementById('kunde-geschlecht').value,
            };

            try {
                const url = id ? `${API_URL}/kunden/${id}` : `${API_URL}/kunden`;
                const method = id ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(kunde)
                });

                if (res.ok) {
                    showNotification('Kunde gespeichert');
                    hideKundeForm();
                    loadKunden();
                } else {
                    showNotification('Fehler beim Speichern', 'error');
                }
            } catch (error) {
                showNotification('Fehler beim Speichern', 'error');
            }
        }

        async function deleteKunde(id) {
            if (!confirm('Kunde wirklich löschen?')) return;

            try {
                const res = await fetch(`${API_URL}/kunden/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    showNotification('Kunde gelöscht');
                    loadKunden();
                } else {
                    showNotification('Fehler beim Löschen', 'error');
                }
            } catch (error) {
                showNotification('Fehler beim Löschen', 'error');
            }
        }

        // Produkte
        async function loadProdukte() {
            try {
                const res = await fetch(`${API_URL}/produkte`);
                produkte = await res.json();
                document.getElementById('produkte-list').innerHTML = produkte.map(p => `
                    <tr>
                        <td class="px-6 py-4">${p.id}</td>
                        <td class="px-6 py-4 font-medium">${p.name}</td>
                        <td class="px-6 py-4">${p.beschreibung || '-'}</td>
                        <td class="px-6 py-4">${p.preis.toFixed(2)} €</td>
                        <td class="px-6 py-4">${p.lagerbestand}</td>
                        <td class="px-6 py-4">
                            <button onclick="editProdukt(${p.id})" class="text-blue-600 hover:text-blue-800 mr-3">Bearbeiten</button>
                            <button onclick="deleteProdukt(${p.id})" class="text-red-600 hover:text-red-800">Löschen</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showNotification('Fehler beim Laden der Produkte', 'error');
            }
        }

        function showProduktForm() {
            document.getElementById('produkt-form').classList.remove('hidden');
            document.getElementById('produkt-id').value = '';
            document.getElementById('produkt-name').value = '';
            document.getElementById('produkt-preis').value = '';
            document.getElementById('produkt-lagerbestand').value = '';
            document.getElementById('produkt-beschreibung').value = '';
        }

        function hideProduktForm() {
            document.getElementById('produkt-form').classList.add('hidden');
        }

        async function editProdukt(id) {
            const produkt = produkte.find(p => p.id === id);
            if (!produkt) return;

            document.getElementById('produkt-form').classList.remove('hidden');
            document.getElementById('produkt-id').value = produkt.id;
            document.getElementById('produkt-name').value = produkt.name;
            document.getElementById('produkt-preis').value = produkt.preis;
            document.getElementById('produkt-lagerbestand').value = produkt.lagerbestand;
            document.getElementById('produkt-beschreibung').value = produkt.beschreibung || '';
        }

        async function saveProdukt(event) {
            event.preventDefault();
            const id = document.getElementById('produkt-id').value;
            const produkt = {
                name: document.getElementById('produkt-name').value,
                preis: parseFloat(document.getElementById('produkt-preis').value),
                lagerbestand: parseInt(document.getElementById('produkt-lagerbestand').value),
                beschreibung: document.getElementById('produkt-beschreibung').value
            };

            try {
                const url = id ? `${API_URL}/produkte/${id}` : `${API_URL}/produkte`;
                const method = id ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(produkt)
                });

                if (res.ok) {
                    showNotification('Produkt gespeichert');
                    hideProduktForm();
                    loadProdukte();
                } else {
                    showNotification('Fehler beim Speichern', 'error');
                }
            } catch (error) {
                showNotification('Fehler beim Speichern', 'error');
            }
        }

        async function deleteProdukt(id) {
            if (!confirm('Produkt wirklich löschen?')) return;

            try {
                const res = await fetch(`${API_URL}/produkte/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    showNotification('Produkt gelöscht');
                    loadProdukte();
                } else {
                    showNotification('Fehler beim Löschen', 'error');
                }
            } catch (error) {
                showNotification('Fehler beim Löschen', 'error');
            }
        }

        // Bestellungen
        async function loadBestellungen() {
            try {
                const res = await fetch(`${API_URL}/bestellungen`);
                bestellungen = await res.json();

                document.getElementById('bestellungen-list').innerHTML = bestellungen.map(b => `
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold">Bestellung #${b.id}</h3>
                                <p class="text-gray-500">Status: <span class="font-medium">${b.status}</span></p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-purple-600">${b.gesamtpreis.toFixed(2)} €</div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            ${b.positionen.map(p => `
                                <div class="flex justify-between text-sm">
                                    <span>${p.produkt.name} × ${p.menge}</span>
                                    <span>${p.gesamtpreis.toFixed(2)} €</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showNotification('Fehler beim Laden der Bestellungen', 'error');
            }
        }

        async function showBestellungForm() {
            document.getElementById('bestellung-form').classList.remove('hidden');

            // Kunden laden
            if (kunden.length === 0) {
                const res = await fetch(`${API_URL}/kunden`);
                kunden = await res.json();
            }

            document.getElementById('bestellung-kunde').innerHTML =
                '<option value="">Kunde wählen</option>' +
                kunden.map(k => `<option value="${k.id}">${k.vorname} ${k.name}</option>`).join('');

            // Produkte laden
            if (produkte.length === 0) {
                const res = await fetch(`${API_URL}/produkte`);
                produkte = await res.json();
            }

            document.getElementById('bestellung-positionen').innerHTML = '';
            addPosition();
        }

        function hideBestellungForm() {
            document.getElementById('bestellung-form').classList.add('hidden');
        }

        function addPosition() {
            const container = document.getElementById('bestellung-positionen');
            const div = document.createElement('div');
            div.className = 'flex gap-2 mb-2';
            div.innerHTML = `
                <select class="position-produkt flex-1 px-3 py-2 border rounded" required>
                    <option value="">Produkt wählen</option>
                    ${produkte.map(p => `<option value="${p.id}">${p.name} (${p.preis.toFixed(2)} €)</option>`).join('')}
                </select>
                <input type="number" class="position-menge w-24 px-3 py-2 border rounded" placeholder="Menge" min="1" required>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-600 hover:text-red-800">✕</button>
            `;
            container.appendChild(div);
        }

        async function saveBestellung(event) {
            event.preventDefault();

            const kundeId = parseInt(document.getElementById('bestellung-kunde').value);
            const positionElements = document.querySelectorAll('#bestellung-positionen > div');

            const positionen = Array.from(positionElements).map(el => ({
                produktId: parseInt(el.querySelector('.position-produkt').value),
                menge: parseInt(el.querySelector('.position-menge').value)
            }));

            if (positionen.length === 0) {
                showNotification('Mindestens eine Position erforderlich', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/bestellungen`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ kundeId, positionen })
                });

                if (res.ok) {
                    showNotification('Bestellung erstellt');
                    hideBestellungForm();
                    loadBestellungen();
                } else {
                    const error = await res.json();
                    showNotification(error.message || 'Fehler beim Erstellen', 'error');
                }
            } catch (error) {
                showNotification('Fehler beim Erstellen', 'error');
            }
        }

        // Rechnungen
        async function loadRechnungen() {
            try {
                const res = await fetch(`${API_URL}/rechnungen`);
                if (!res.ok) {
                    // Try to extract server error message
                    const text = await res.text().catch(() => '');
                    console.error('Failed to load rechnungen', res.status, res.statusText, text);
                    showNotification(`Fehler beim Laden der Rechnungen: ${res.status} ${res.statusText}`, 'error');
                    return;
                }
                // parse JSON safely
                let rechnungen;
                try {
                    rechnungen = await res.json();
                } catch (e) {
                    const txt = await res.text().catch(() => '');
                    console.error('Failed to parse rechnungen JSON', e, txt);
                    showNotification('Fehler: Ungültige Antwort vom Server beim Laden der Rechnungen', 'error');
                    return;
                }

                document.getElementById('rechnungen-list').innerHTML = rechnungen.map(r => {
                    const created = r.erstellungsdatum ? formatDate(r.erstellungsdatum) : '-';
                    return `
                    <tr>
                        <td class="px-6 py-4">${r.id}</td>
                        <td class="px-6 py-4 font-medium">${r.rechnungsnummer}</td>
                        <td class="px-6 py-4">${r.bestellungId}</td>
                        <td class="px-6 py-4">${r.kundeName}</td>
                        <td class="px-6 py-4">${created}</td>
                        <td class="px-6 py-4">${Number(r.gesamtbetrag).toFixed(2)} €</td>
                        <td class="px-6 py-4">${r.status}</td>
                        <td class="px-6 py-4">
                            <button onclick="downloadRechnungPdf(${r.id})" class="text-indigo-600 hover:text-indigo-800 mr-3">PDF</button>
                            ${r.status === 'OFFEN' ? `<button onclick="markAsPaid(${r.id})" class="text-green-600 hover:text-green-800 mr-3">Bezahlt</button>` : ''}
                        </td>
                    </tr>
                `}).join('');
            } catch (error) {
                console.error('Unexpected error loading rechnungen', error);
                showNotification('Fehler beim Laden der Rechnungen', 'error');
            }
        }

        async function createRechnung() {
            const id = document.getElementById('create-rechnung-bestellung-id').value;
            if (!id) { showNotification('Bitte Bestellungs-ID angeben', 'error'); return; }
            try {
                // First check whether a Rechnung for this Bestellung already exists
                const checkRes = await fetch(`${API_URL}/rechnungen/bestellung/${id}`);
                if (checkRes.ok) {
                    // There is already a Rechnung for this Bestellung -> inform user
                    const existing = await checkRes.json().catch(() => ({}));
                    const num = existing.rechnungsnummer ? ` (${existing.rechnungsnummer})` : '';
                    showNotification(`Rechnung für Bestellung ${id} existiert bereits${num}`, 'error');
                    return;
                } else if (checkRes.status !== 404) {
                    // unexpected error while checking
                    const txt = await checkRes.text().catch(() => '');
                    console.error('Fehler beim Prüfen vorhandener Rechnung', checkRes.status, txt);
                    showNotification('Fehler beim Prüfen vorhandener Rechnung', 'error');
                    return;
                }

                // No existing Rechnung -> create one
                const res = await fetch(`${API_URL}/rechnungen/erstellen/${id}`, { method: 'POST' });
                if (res.status === 201) {
                    showNotification('Rechnung erstellt');
                    loadRechnungen();
                } else if (res.status === 409) {
                    // Conflict: invoice already exists (race or server-side prevention)
                    const err = await res.json().catch(() => ({}));
                    showNotification(err.error || `Rechnung für Bestellung ${id} existiert bereits`, 'error');
                } else {
                    const err = await res.json().catch(() => ({}));
                    showNotification(err.error || 'Fehler beim Erstellen der Rechnung', 'error');
                }
            } catch (error) {
                showNotification('Fehler beim Erstellen der Rechnung', 'error');
            }
        }

        async function rechnungslauf(params) {
            try {
                const res = await fetch(`${API_URL}/rechnungen/rechnungslauf`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params || {})
                });
                if (res.ok) {
                    const result = await res.json().catch(() => ({}));
                    showNotification(result.message);
                    loadRechnungen();
                } else {
                    const err = await res.json().catch(() => ({}));
                    showNotification(err.error || 'Fehler beim Rechnungslauf', 'error');
                }
            } catch (error) {
                console.error('Error during rechnungslauf', error);
                showNotification('Fehler beim Rechnungslauf', 'error');
            }
        }

        async function markAsPaid(id) {
            try {
                const res = await fetch(`${API_URL}/rechnungen/${id}/bezahlen`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bearbeiter: 'WebUI' })
                });
                if (res.ok) {
                    showNotification('Rechnung als bezahlt markiert');
                    loadRechnungen();
                } else {
                    const err = await res.json().catch(() => ({}));
                    showNotification(err.error || 'Fehler beim Markieren', 'error');
                }
            } catch (error) {
                console.error('Error marking invoice as paid', error);
                showNotification('Fehler beim Markieren der Rechnung', 'error');
            }
        }

        function downloadRechnungPdf(id) {
            // open download in new tab
            const url = `${API_URL}/rechnungen/${id}/pdf`;
            window.open(url, '_blank');
        }

        // viewRechnung removed: details are shown in the Rechnungen overview

        // Init
        loadDashboard();
    </script>
</body>

</html>